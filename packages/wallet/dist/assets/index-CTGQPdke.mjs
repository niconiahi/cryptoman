import{d as k,a as _,u as a,y as E,k as q,E as F}from"./preact-10.26.9-BHuVZBHX.mjs";import{v as R,m as D,H as C,g as L,k as j,w as $,p,o as b,a as G,n as U,b as N,c as T,s as f,u as B,d as V,l as I,e as H}from"./vendor-aIpykqOZ.mjs";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();const A={iterations:1e5,hash:"SHA-256"},c={name:"cryptoman/signer",version:1,store_name:"vault",vault_key:"credentials"};function v(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}function h(e){return Uint8Array.from(atob(e),t=>t.charCodeAt(0))}async function M(e,t,r){const o=new TextEncoder().encode(e),n=await crypto.subtle.importKey("raw",o,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:A.iterations,hash:A.hash},n,{name:"AES-GCM",length:256},!1,r)}function g(){return new Promise((e,t)=>{const r=indexedDB.open(c.name,c.version);r.onupgradeneeded=o=>{const n=o.target.result;n.objectStoreNames.contains(c.store_name)||n.createObjectStore(c.store_name)},r.onsuccess=()=>e(r.result),r.onerror=()=>t(new Error(`Failed to open database: ${r.error?.message}`))})}async function Y(e,t){if(!e.trim())throw new Error("Mnemonic cannot be empty");if(!t.trim())throw new Error("Password cannot be empty");const r=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),n=await M(t,r,["encrypt"]),s=new TextEncoder().encode(e),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},n,s),w={salt:v(r),iv:v(o),cipher:v(i)},l=await g();return new Promise((y,S)=>{const m=l.transaction(c.store_name,"readwrite").objectStore(c.store_name).put(w,c.vault_key);m.onsuccess=()=>y(),m.onerror=()=>S(new Error(`Failed to save vault: ${m.error?.message}`))})}async function O(e){if(!e.trim())throw new Error("Password cannot be empty");const t=await g(),r=await new Promise((l,y)=>{const d=t.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);d.onsuccess=()=>{const m=d.result;l(m)},d.onerror=()=>y(new Error(`Failed to load vault: ${d.error?.message}`))});if(!r)return;const o=h(r.salt),n=h(r.iv),s=h(r.cipher),i=await M(e,o,["decrypt"]),w=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},i,s).catch(l=>{throw l instanceof Error?new Error("Invalid password or corrupted vault"):new Error("invalid unkwown error")});return new TextDecoder().decode(w)}async function P(){const e=await g();return new Promise(t=>{const n=e.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);n.onsuccess=()=>t(!!n.result),n.onerror=()=>t(!1)})}async function W(e){try{return await O(e)!==void 0}catch{return!1}}const z="Invariant failed";function J(e,t){if(e)return;const o=`${z}: ${t}`;throw new Error(o)}function Q(e){if(!R(e,$))throw new Error("Invalid mnemonic");return D(e)}function X(e){return C.fromMasterSeed(e)}function Z(e,t="m/44'/60'/0'/0/0"){const r=e.derive(t);if(!r.privateKey)throw new Error("No private key available");return r.privateKey}function ee(e){const t=L(e,!1),r=j(t.slice(1));return`0x${te(r.slice(-20))}`}function te(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}const ne=k({key:new C({privateKey:new Uint8Array(32).fill(1)}),address:""});async function re(e){await chrome.storage.sync.set({wallet:e})}async function oe(e){const t=await O(e);J(t,"vault should exist to sign in");const r=Q(t),o=X(r),n=Z(o),i={address:ee(n),key:o};i.value=i,re()}const se="password",u=k(se);async function x(){const e=Date.now();await chrome.storage.sync.set({timestamp:e})}async function ae(){return p(b({timestamp:G(U())}),await chrome.storage.sync.get("timestamp")).timestamp}async function ce(){const e=Date.now(),t=await ae();if(!t)return!1;const r=e-t,o=300*1e3;return r<o}function ie(){const[e,t]=_("");return a("div",{children:[a("input",{placeholder:"Password",value:e,onInput:r=>{const o=r.currentTarget.value;t(o)}}),a("button",{type:"button",onClick:async()=>{await W(e)&&(await x(),await oe(e),u.value="wallet")},children:"unlock"})]})}function ue(){return a("div",{children:a("span",{children:["the connected address is ",ne.value.address]})})}const le=N(f(),T(8)),de=N(f(),T(1));function me(){const[e,t]=_(""),[r,o]=_("smile price bomb movie minimum treat hurdle adult wing come space cross");return a("main",{children:[a("input",{placeholder:"Mnemonics",value:r,onInput:n=>{const s=n.currentTarget.value;o(s)}}),a("input",{placeholder:"Password",value:e,onInput:n=>{const s=n.currentTarget.value;t(s)}}),a("button",{type:"button",onClick:async()=>{const n=p(de,r),s=p(le,e);Y(n,s),await x(),u.value="password"},children:"save wallet"})]})}const fe=b({id:f(),type:I("CRYPTOMAN_SIGN_TRANSACTION"),method:f(),params:V(H())}),pe=b({id:f(),type:I("CRYPTOMAN_CONNECT")}),we=B([fe,pe]);function ye(){return E(()=>{async function e(){await P()||(u.value="mnemonics")}e()},[]),E(()=>{chrome.runtime.onMessage.addListener(async(e,t,r)=>{switch(p(we,e).type){case"CRYPTOMAN_CONNECT":{console.log("message",e),console.log("sender",t),console.log("sendResponse",r);const n=await ce();if(n){u.value="wallet";return}if(!await P())u.value="mnemonics";else{if(!n){u.value="mnemonics";return}u.value="password"}}}})},[]),a(q,{children:ve(u.value)})}function ve(e){switch(e){case"mnemonics":return a(me,{});case"password":return a(ie,{});case"wallet":return a(ue,{});default:return a("div",{children:["there is no view for: ",e]})}}F(a(ye,{}),document.querySelector("#app"));
