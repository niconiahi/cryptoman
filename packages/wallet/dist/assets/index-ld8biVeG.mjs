import{d as C,a as h,u as a,y as E,k as R,E as D}from"./preact-10.26.9-BHuVZBHX.mjs";import{v as L,m as j,H as N,g as $,k as G,w as U,p as w,o as b,a as B,n as V,b as T,c as I,s as f,u as H,d as Y,l as M,e as W}from"./vendor-aIpykqOZ.mjs";(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function n(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=n(t);fetch(t.href,s)}})();const A={iterations:1e5,hash:"SHA-256"},c={name:"cryptoman/signer",version:1,store_name:"vault",vault_key:"credentials"};function y(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}function _(e){return Uint8Array.from(atob(e),r=>r.charCodeAt(0))}async function O(e,r,n){const o=new TextEncoder().encode(e),t=await crypto.subtle.importKey("raw",o,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:r,iterations:A.iterations,hash:A.hash},t,{name:"AES-GCM",length:256},!1,n)}function g(){return new Promise((e,r)=>{const n=indexedDB.open(c.name,c.version);n.onupgradeneeded=o=>{const t=o.target.result;t.objectStoreNames.contains(c.store_name)||t.createObjectStore(c.store_name)},n.onsuccess=()=>e(n.result),n.onerror=()=>r(new Error(`Failed to open database: ${n.error?.message}`))})}async function z(e,r){if(!e.trim())throw new Error("Mnemonic cannot be empty");if(!r.trim())throw new Error("Password cannot be empty");const n=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),t=await O(r,n,["encrypt"]),s=new TextEncoder().encode(e),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,s),l={salt:y(n),iv:y(o),cipher:y(i)},d=await g();return new Promise((v,S)=>{const p=d.transaction(c.store_name,"readwrite").objectStore(c.store_name).put(l,c.vault_key);p.onsuccess=()=>v(),p.onerror=()=>S(new Error(`Failed to save vault: ${p.error?.message}`))})}async function x(e){if(!e.trim())throw new Error("Password cannot be empty");const r=await g(),n=await new Promise((d,v)=>{const m=r.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);m.onsuccess=()=>{const p=m.result;d(p)},m.onerror=()=>v(new Error(`Failed to load vault: ${m.error?.message}`))});if(!n)return;const o=_(n.salt),t=_(n.iv),s=_(n.cipher),i=await O(e,o,["decrypt"]),l=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},i,s).catch(d=>{throw d instanceof Error?new Error("Invalid password or corrupted vault"):new Error("invalid unkwown error")});return new TextDecoder().decode(l)}async function P(){const e=await g();return new Promise(r=>{const t=e.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);t.onsuccess=()=>r(!!t.result),t.onerror=()=>r(!1)})}async function J(e){try{return await x(e)!==void 0}catch{return!1}}const Q="Invariant failed";function X(e,r){if(e)return;const o=`${Q}: ${r}`;throw new Error(o)}function Z(e){if(!L(e,U))throw new Error("Invalid mnemonic");return j(e)}function ee(e){return N.fromMasterSeed(e)}function te(e,r="m/44'/60'/0'/0/0"){const n=e.derive(r);if(!n.privateKey)throw new Error("No private key available");return n.privateKey}function ne(e){const r=$(e,!1),n=G(r.slice(1));return`0x${re(n.slice(-20))}`}function re(e){return Array.from(e).map(r=>r.toString(16).padStart(2,"0")).join("")}const K=C({key:new N({privateKey:new Uint8Array(32).fill(1)}),address:""}),oe="password",u=C(oe);async function q(){const e=Date.now();await chrome.storage.sync.set({timestamp:e})}async function k(){const e=Date.now(),r=await chrome.storage.sync.get("timestamp");console.log("bla",r);const n=w(b({timestamp:B(V())}),r);if(n.timestamp,console.log("now",e),console.log("timestamp",n),!n)return!1;const o=e-n;console.log("elapsed",o);const t=300*1e3;return o<t}function se(){const[e,r]=h("");return a("div",{children:[a("input",{placeholder:"Password",value:e,onInput:n=>{const o=n.currentTarget.value;r(o)}}),a("button",{type:"button",onClick:async()=>{if(!await J(e))return;const o=await x(e);X(o,"vault should exist to sign in");const t=Z(o),s=ee(t),i=te(s),l=ne(i);K.value={address:l,key:s},await q(),u.value="wallet"},children:"unlock"})]})}function ae(){return a("div",{children:a("span",{children:["the connected address is ",K.value.address]})})}const ce=T(f(),I(8)),ie=T(f(),I(1));function ue(){const[e,r]=h(""),[n,o]=h("smile price bomb movie minimum treat hurdle adult wing come space cross");return a("main",{children:[a("input",{placeholder:"Mnemonics",value:n,onInput:t=>{const s=t.currentTarget.value;o(s)}}),a("input",{placeholder:"Password",value:e,onInput:t=>{const s=t.currentTarget.value;r(s)}}),a("button",{type:"button",onClick:async()=>{const t=w(ie,n),s=w(ce,e);z(t,s),await q(),u.value="password"},children:"save wallet"})]})}const le=b({id:f(),type:M("CRYPTOMAN_SIGN_TRANSACTION"),method:f(),params:Y(W())}),de=b({id:f(),type:M("CRYPTOMAN_CONNECT")}),me=H([le,de]);function pe(){return E(()=>{async function e(){await P()||(u.value="mnemonics")}e()},[]),E(()=>{chrome.runtime.onMessage.addListener(async(e,r,n)=>{switch(w(me,e).type){case"CRYPTOMAN_CONNECT":{console.log("message",e),console.log("sender",r),console.log("sendResponse",n),console.log("is_timestamp_valid()",k());const t=k();if(t)return;if(!await P())u.value="mnemonics";else{if(!t){u.value="mnemonics";return}u.value="password"}}}})},[]),a(R,{children:fe(u.value)})}function fe(e){switch(e){case"mnemonics":return a(ue,{});case"password":return a(se,{});case"wallet":return a(ae,{});default:return a("div",{children:["there is no view for: ",e]})}}D(a(pe,{}),document.querySelector("#app"));
