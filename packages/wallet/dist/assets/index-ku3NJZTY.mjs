import{d as k,a as h,u as a,y as E,k as F,E as R}from"./preact-10.26.9-BHuVZBHX.mjs";import{v as D,m as L,H as C,g as j,k as $,w as G,p as w,a as b,t as U,s as l,b as N,u as B,o as I,l as T,c as V,d as H}from"./vendor-BBm_0UZ6.mjs";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))o(t);new MutationObserver(t=>{for(const s of t)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function r(t){const s={};return t.integrity&&(s.integrity=t.integrity),t.referrerPolicy&&(s.referrerPolicy=t.referrerPolicy),t.crossOrigin==="use-credentials"?s.credentials="include":t.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(t){if(t.ep)return;t.ep=!0;const s=r(t);fetch(t.href,s)}})();const A={iterations:1e5,hash:"SHA-256"},c={name:"cryptoman/signer",version:1,store_name:"vault",vault_key:"credentials"};function y(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}function _(e){return Uint8Array.from(atob(e),n=>n.charCodeAt(0))}async function M(e,n,r){const o=new TextEncoder().encode(e),t=await crypto.subtle.importKey("raw",o,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:A.iterations,hash:A.hash},t,{name:"AES-GCM",length:256},!1,r)}function g(){return new Promise((e,n)=>{const r=indexedDB.open(c.name,c.version);r.onupgradeneeded=o=>{const t=o.target.result;t.objectStoreNames.contains(c.store_name)||t.createObjectStore(c.store_name)},r.onsuccess=()=>e(r.result),r.onerror=()=>n(new Error(`Failed to open database: ${r.error?.message}`))})}async function Y(e,n){if(!e.trim())throw new Error("Mnemonic cannot be empty");if(!n.trim())throw new Error("Password cannot be empty");const r=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),t=await M(n,r,["encrypt"]),s=new TextEncoder().encode(e),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,s),d={salt:y(r),iv:y(o),cipher:y(i)},m=await g();return new Promise((v,S)=>{const f=m.transaction(c.store_name,"readwrite").objectStore(c.store_name).put(d,c.vault_key);f.onsuccess=()=>v(),f.onerror=()=>S(new Error(`Failed to save vault: ${f.error?.message}`))})}async function O(e){if(!e.trim())throw new Error("Password cannot be empty");const n=await g(),r=await new Promise((m,v)=>{const p=n.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);p.onsuccess=()=>{const f=p.result;m(f)},p.onerror=()=>v(new Error(`Failed to load vault: ${p.error?.message}`))});if(!r)return;const o=_(r.salt),t=_(r.iv),s=_(r.cipher),i=await M(e,o,["decrypt"]),d=await crypto.subtle.decrypt({name:"AES-GCM",iv:t},i,s).catch(m=>{throw m instanceof Error?new Error("Invalid password or corrupted vault"):new Error("invalid unkwown error")});return new TextDecoder().decode(d)}async function P(){const e=await g();return new Promise(n=>{const t=e.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);t.onsuccess=()=>n(!!t.result),t.onerror=()=>n(!1)})}async function W(e){try{return await O(e)!==void 0}catch{return!1}}const z="Invariant failed";function J(e,n){if(e)return;const o=`${z}: ${n}`;throw new Error(o)}function Q(e){if(!D(e,G))throw new Error("Invalid mnemonic");return L(e)}function X(e){return C.fromMasterSeed(e)}function Z(e,n="m/44'/60'/0'/0/0"){const r=e.derive(n);if(!r.privateKey)throw new Error("No private key available");return r.privateKey}function ee(e){const n=j(e,!1),r=$(n.slice(1));return`0x${te(r.slice(-20))}`}function te(e){return Array.from(e).map(n=>n.toString(16).padStart(2,"0")).join("")}const x=k({key:new C({privateKey:new Uint8Array(32).fill(1)}),address:""}),ne="password",u=k(ne);function K(){const e=Date.now();window.sessionStorage.setItem("timestamp",String(e))}function re(){const e=Date.now(),n=w(b(l(),U(Number)),window.sessionStorage.getItem("timestamp")),r=e-n,o=300*1e3;return r<o}function oe(){const[e,n]=h("");return a("div",{children:[a("input",{placeholder:"Password",value:e,onInput:r=>{const o=r.currentTarget.value;n(o)}}),a("button",{type:"button",onClick:async()=>{if(!await W(e))return;const o=await O(e);J(o,"vault should exist to sign in");const t=Q(o),s=X(t),i=Z(s),d=ee(i);x.value={address:d,key:s},K(),u.value="wallet"},children:"unlock"})]})}function se(){return a("div",{children:a("span",{children:["the connected address is ",x.value.address]})})}const ae=b(l(),N(8)),ce=b(l(),N(1));function ie(){const[e,n]=h(""),[r,o]=h("smile price bomb movie minimum treat hurdle adult wing come space cross");return a("main",{children:[a("input",{placeholder:"Mnemonics",value:r,onInput:t=>{const s=t.currentTarget.value;o(s)}}),a("input",{placeholder:"Password",value:e,onInput:t=>{const s=t.currentTarget.value;n(s)}}),a("button",{type:"button",onClick:()=>{const t=w(ce,r),s=w(ae,e);Y(t,s),K(),u.value="password"},children:"save wallet"})]})}const ue=I({id:l(),type:T("CRYPTOMAN_SIGN_TRANSACTION"),method:l(),params:V(H())}),le=I({id:l(),type:T("CRYPTOMAN_CONNECT")}),de=B([ue,le]);function me(){return E(()=>{async function e(){await P()||(u.value="mnemonics")}e()},[]),E(()=>{chrome.runtime.onMessage.addListener(async(e,n,r)=>{switch(w(de,e).type){case"CRYPTOMAN_CONNECT":{if(console.log("message",e),console.log("sender",n),console.log("sendResponse",r),re())return;await P()?u.value="password":u.value="mnemonics"}}})},[]),a(F,{children:pe(u.value)})}function pe(e){switch(e){case"mnemonics":return a(ie,{});case"password":return a(oe,{});case"wallet":return a(se,{});default:return a("div",{children:["there is no view for: ",e]})}}R(a(me,{}),document.querySelector("#app"));
