import{d as N,a as g,u as a,y as A,k as R,E as D}from"./preact-10.26.9-BHuVZBHX.mjs";import{v as L,m as j,H as b,g as $,k as G,w as U,p,o as w,a as T,s as l,n as B,b as I,c as x,u as V,d as H,l as O,e as W}from"./vendor-aIpykqOZ.mjs";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function r(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(n){if(n.ep)return;n.ep=!0;const o=r(n);fetch(n.href,o)}})();const P={iterations:1e5,hash:"SHA-256"},c={name:"cryptoman/signer",version:1,store_name:"vault",vault_key:"credentials"};function _(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}function h(e){return Uint8Array.from(atob(e),t=>t.charCodeAt(0))}async function M(e,t,r){const s=new TextEncoder().encode(e),n=await crypto.subtle.importKey("raw",s,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:P.iterations,hash:P.hash},n,{name:"AES-GCM",length:256},!1,r)}function S(){return new Promise((e,t)=>{const r=indexedDB.open(c.name,c.version);r.onupgradeneeded=s=>{const n=s.target.result;n.objectStoreNames.contains(c.store_name)||n.createObjectStore(c.store_name)},r.onsuccess=()=>e(r.result),r.onerror=()=>t(new Error(`Failed to open database: ${r.error?.message}`))})}async function Y(e,t){if(!e.trim())throw new Error("Mnemonic cannot be empty");if(!t.trim())throw new Error("Password cannot be empty");const r=crypto.getRandomValues(new Uint8Array(16)),s=crypto.getRandomValues(new Uint8Array(12)),n=await M(t,r,["encrypt"]),o=new TextEncoder().encode(e),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:s},n,o),y={salt:_(r),iv:_(s),cipher:_(i)},d=await S();return new Promise((v,k)=>{const f=d.transaction(c.store_name,"readwrite").objectStore(c.store_name).put(y,c.vault_key);f.onsuccess=()=>v(),f.onerror=()=>k(new Error(`Failed to save vault: ${f.error?.message}`))})}async function K(e){if(!e.trim())throw new Error("Password cannot be empty");const t=await S(),r=await new Promise((d,v)=>{const m=t.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);m.onsuccess=()=>{const f=m.result;d(f)},m.onerror=()=>v(new Error(`Failed to load vault: ${m.error?.message}`))});if(!r)return;const s=h(r.salt),n=h(r.iv),o=h(r.cipher),i=await M(e,s,["decrypt"]),y=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},i,o).catch(d=>{throw d instanceof Error?new Error("Invalid password or corrupted vault"):new Error("invalid unkwown error")});return new TextDecoder().decode(y)}async function C(){const e=await S();return new Promise(t=>{const n=e.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);n.onsuccess=()=>t(!!n.result),n.onerror=()=>t(!1)})}async function J(e){try{return await K(e)!==void 0}catch{return!1}}const z="Invariant failed";function Q(e,t){if(e)return;const s=`${z}: ${t}`;throw new Error(s)}function X(e){if(!L(e,U))throw new Error("Invalid mnemonic");return j(e)}function Z(e){return b.fromMasterSeed(e)}function ee(e,t="m/44'/60'/0'/0/0"){const r=e.derive(t);if(!r.privateKey)throw new Error("No private key available");return r.privateKey}function te(e){const t=$(e,!1),r=G(t.slice(1));return`0x${ne(r.slice(-20))}`}function ne(e){return Array.from(e).map(t=>t.toString(16).padStart(2,"0")).join("")}const re=w({address:l(),private_key:l()}),E=N({address:"",key:new b({privateKey:new Uint8Array(32).fill(1)})});async function se(e){const t={address:e.address,private_key:e.key.toJSON().xpriv};await chrome.storage.sync.set({wallet:t})}async function oe(){const t=p(w({wallet:T(re)}),await chrome.storage.sync.get("wallet")).wallet;console.log("stored_wallet",t),t&&(E.value={address:t.address,key:b.fromExtendedKey(t.private_key)})}async function ae(e){const t=await K(e);Q(t,"vault should exist to sign in");const r=X(t),s=Z(r),n=ee(s),i={address:te(n),key:s};E.value=i,se(i)}const ce="password",u=N(ce);async function q(){const e=Date.now();await chrome.storage.sync.set({timestamp:e})}async function ie(){return p(w({timestamp:T(B())}),await chrome.storage.sync.get("timestamp")).timestamp}async function ue(){const e=Date.now(),t=await ie();if(!t)return!1;const r=e-t,s=300*1e3;return r<s}function le(){const[e,t]=g("");return a("div",{children:[a("input",{placeholder:"Password",value:e,onInput:r=>{const s=r.currentTarget.value;t(s)}}),a("button",{type:"button",onClick:async()=>{await J(e)&&(await q(),await ae(e),u.value="wallet")},children:"unlock"})]})}function de(){return a("div",{children:a("span",{children:["the connected address is ",E.value.address]})})}const me=I(l(),x(8)),fe=I(l(),x(1));function pe(){const[e,t]=g(""),[r,s]=g("smile price bomb movie minimum treat hurdle adult wing come space cross");return a("main",{children:[a("input",{placeholder:"Mnemonics",value:r,onInput:n=>{const o=n.currentTarget.value;s(o)}}),a("input",{placeholder:"Password",value:e,onInput:n=>{const o=n.currentTarget.value;t(o)}}),a("button",{type:"button",onClick:async()=>{const n=p(fe,r),o=p(me,e);Y(n,o),await q(),u.value="password"},children:"save wallet"})]})}const we=w({id:l(),type:O("CRYPTOMAN_SIGN_TRANSACTION"),method:l(),params:H(W())}),ye=w({id:l(),type:O("CRYPTOMAN_CONNECT")}),ve=V([we,ye]);function _e(){return A(()=>{async function e(){await C()||(u.value="mnemonics")}e()},[]),A(()=>{chrome.runtime.onMessage.addListener(async(e,t,r)=>{switch(p(ve,e).type){case"CRYPTOMAN_CONNECT":{console.log("message",e),console.log("sender",t),console.log("sendResponse",r);const n=await ue();if(n){await oe(),u.value="wallet";return}if(!await C())u.value="mnemonics";else{if(!n){u.value="mnemonics";return}u.value="password"}}}})},[]),a(R,{children:he(u.value)})}function he(e){switch(e){case"mnemonics":return a(pe,{});case"password":return a(le,{});case"wallet":return a(de,{});default:return a("div",{children:["there is no view for: ",e]})}}D(a(_e,{}),document.querySelector("#app"));
