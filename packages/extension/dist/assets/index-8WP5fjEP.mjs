import{d,u as a,T as O,y as I,E as T}from"./preact-10.26.9-CUZTX216.mjs";import{c as x,s as E,a as K,b as V,f as y,d as g,p as S,m as C,e as M}from"./vendor-zV95du-5.mjs";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))o(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const c of s.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function r(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(n){if(n.ep)return;n.ep=!0;const s=r(n);fetch(n.href,s)}})();function U({authentication:e}){const[t,r]=d("");return a("div",{children:[a("input",{placeholder:"Password",value:t,onInput:o=>{const n=o.currentTarget.value;r(n)}}),a("button",{type:"button",onClick:()=>{e[1]({type:"UNLOCK_WALLET",password:t})},children:"unlock"})]})}const b={iterations:1e5,hash:"SHA-256"},i={name:"walle",version:1,store_name:"vault",vault_key:"vault"};function v(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}function f(e){return Uint8Array.from(atob(e),t=>t.charCodeAt(0))}async function P(e,t,r){const o=new TextEncoder().encode(e),n=await crypto.subtle.importKey("raw",o,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:t,iterations:b.iterations,hash:b.hash},n,{name:"AES-GCM",length:256},!1,r)}function _(){return new Promise((e,t)=>{const r=indexedDB.open(i.name,i.version);r.onupgradeneeded=o=>{const n=o.target.result;n.objectStoreNames.contains(i.store_name)||n.createObjectStore(i.store_name)},r.onsuccess=()=>e(r.result),r.onerror=()=>t(new Error(`Failed to open database: ${r.error?.message}`))})}async function A(e,t){if(!e.trim())throw new Error("Mnemonic cannot be empty");if(!t.trim())throw new Error("Password cannot be empty");const r=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),n=await P(t,r,["encrypt"]),s=new TextEncoder().encode(e),c=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},n,s),w={salt:v(r),iv:v(o),cipher:v(c)},u=await _();return new Promise((m,h)=>{const p=u.transaction(i.store_name,"readwrite").objectStore(i.store_name).put(w,i.vault_key);p.onsuccess=()=>m(),p.onerror=()=>h(new Error(`Failed to save vault: ${p.error?.message}`))})}async function k(e){if(!e.trim())throw new Error("Password cannot be empty");const t=await _(),r=await new Promise((u,m)=>{const l=t.transaction(i.store_name,"readonly").objectStore(i.store_name).get(i.vault_key);l.onsuccess=()=>{const p=l.result;u(p)},l.onerror=()=>m(new Error(`Failed to load vault: ${l.error?.message}`))});if(!r)return;const o=f(r.salt),n=f(r.iv),s=f(r.cipher),c=await P(e,o,["decrypt"]),w=await crypto.subtle.decrypt({name:"AES-GCM",iv:n},c,s).catch(u=>{throw u instanceof Error?new Error("Invalid password or corrupted vault"):new Error("invalid unkwown error")});return new TextDecoder().decode(w)}async function F(){const e=await _();return new Promise(t=>{const n=e.transaction(i.store_name,"readonly").objectStore(i.store_name).get(i.vault_key);n.onsuccess=()=>t(!!n.result),n.onerror=()=>t(!1)})}async function D(e){try{return await k(e)!==void 0}catch{return!1}}function W({authentication:e}){const[t,r]=d(""),[o,n]=d("test123"),s=e[0].value;return a("div",{children:[a("span",{children:["the current state is ",s]}),a("div",{style:{margin:"20px 0",border:"1px solid #ccc",padding:"10px"},children:[a("h3",{children:"Vault Test"}),a("input",{type:"password",value:o,onInput:u=>n(u.target.value),placeholder:"Password"}),a("br",{}),a("button",{type:"button",onClick:async()=>{await A("hello world",o)},children:'Store "hello world"'}),a("button",{type:"button",onClick:async()=>{const u=await k(o);u&&(console.log("message",u),r(u))},children:"Retrieve"}),t&&a("p",{children:t})]}),a("button",{type:"button",onClick:()=>{e[1]({type:"LOCK"})},children:"lock"})]})}function q({authentication:e}){const[t,r]=d(""),[o,n]=d("smile price bomb movie minimum treat hurdle adult wing come space cross");return a("main",{children:[a("input",{placeholder:"Mnemonics",value:o,onInput:s=>{const c=s.currentTarget.value;n(c)}}),a("input",{placeholder:"Password",value:t,onInput:s=>{const c=s.currentTarget.value;r(c)}}),a("button",{type:"button",onClick:()=>{e[1]({type:"SAVE_MNEMONICS",password:t,mnemonics:o})},children:"save wallet"})]})}function L(e,t){const r=O(()=>x(e,t),[e]),[o,n]=d(()=>r.getSnapshot());return I(()=>{const s=r.subscribe(n);return r.start(),()=>{s.unsubscribe(),r.stop()}},[r]),[o,r.send,r]}const j=E({actions:{set_view:K({current:({event:e})=>e.view})}}),B=j.createMachine({id:"view",context:{current:"password"},on:{SET_VIEW:{actions:["set_view"]}}});function G(){return L(B)}const R="Invariant failed";function $(e,t){if(!e)throw new Error(R)}const H=S(M(),C(8)),z=S(M(),C(1)),J=E({actors:{vault_validator:y(async()=>({exists:await F()})),password_validator:y(async({input:e})=>({valid:await D(e.password)}))},guards:{is_valid_password:({event:e})=>e.type==="UNLOCK_WALLET"||e.type==="SAVE_MNEMONICS"?g(H,e.password).success:!1,are_valid_mnemonics:({event:e})=>e.type==="SAVE_MNEMONICS"?g(z,e.mnemonics).success:!1},actions:{go_to_mnemonics:({context:e})=>{e.view.send({type:"SET_VIEW",view:"mnemonics"})},go_to_wallet:({context:e})=>{e.view.send({type:"SET_VIEW",view:"wallet"})},go_to_password:({context:e})=>{e.view.send({type:"SET_VIEW",view:"password"})},save_mnemonics:({event:e})=>{e.type==="SAVE_MNEMONICS"&&A(e.mnemonics,e.password)}}}),Q=J.createMachine({id:"authentication",initial:"locked",context:({input:e})=>({view:e.view}),states:{locked:{initial:"validating",states:{validating:{invoke:{src:"vault_validator",onDone:[{guard:({event:e})=>e.output.exists,target:"password"},{target:"mnemonics"}]}},mnemonics:{entry:["go_to_mnemonics"],on:{SAVE_MNEMONICS:{guard:V(["is_valid_password","are_valid_mnemonics"]),actions:["save_mnemonics"],target:"password"}}},password:{entry:["go_to_password"],initial:"idle",states:{idle:{on:{UNLOCK_WALLET:{guard:"is_valid_password",target:"validating"}}},validating:{invoke:{src:"password_validator",input:({event:e})=>($(e.type==="UNLOCK_WALLET"),{password:e.password}),onDone:[{guard:({event:e})=>e.output.valid,target:"#authentication.unlocked"},{target:"idle"}],onError:{target:"#authentication.locked.password"}}}}}}},unlocked:{entry:["go_to_wallet"],on:{LOCK:{target:"locked"}}}}});function X({view:e}){return L(Q,{input:{view:e}})}function Y(){const e=G(),t=X({view:e[2]}),r=e[0].context.current;switch(r){case"mnemonics":return a(q,{authentication:t});case"password":return a(U,{authentication:t});case"wallet":return a(W,{authentication:t});default:return a("div",{children:["Unknown state: ",r]})}}T(a(Y,{}),document.querySelector("#app"));
