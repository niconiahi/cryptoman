import{d,u as a,y as A,E as O}from"./preact-10.26.9-Cg_eOskk.mjs";import{c as x,s as C,a as I,b,p as _,m as g,d as S,f as N}from"./vendor-BaZXfrn-.mjs";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const s of r)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&o(i)}).observe(document,{childList:!0,subtree:!0});function t(r){const s={};return r.integrity&&(s.integrity=r.integrity),r.referrerPolicy&&(s.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?s.credentials="include":r.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function o(r){if(r.ep)return;r.ep=!0;const s=t(r);fetch(r.href,s)}})();function T({authentication:e}){const[n,t]=d("");return a("div",{children:[a("input",{placeholder:"Password",value:n,onInput:o=>{const r=o.currentTarget.value;t(r)}}),a("button",{type:"button",onClick:()=>{e.send({type:"PASSWORD_SUCCESS",password:n})},children:"unlock"})]})}const E={iterations:1e5,hash:"SHA-256"},c={name:"walle",version:1,store_name:"vault",vault_key:"vault"};function f(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}function h(e){return Uint8Array.from(atob(e),n=>n.charCodeAt(0))}async function P(e,n,t){const o=new TextEncoder().encode(e),r=await crypto.subtle.importKey("raw",o,"PBKDF2",!1,["deriveKey"]);return crypto.subtle.deriveKey({name:"PBKDF2",salt:n,iterations:E.iterations,hash:E.hash},r,{name:"AES-GCM",length:256},!1,t)}function v(){return new Promise((e,n)=>{const t=indexedDB.open(c.name,c.version);t.onupgradeneeded=o=>{const r=o.target.result;r.objectStoreNames.contains(c.store_name)||r.createObjectStore(c.store_name)},t.onsuccess=()=>e(t.result),t.onerror=()=>n(new Error(`Failed to open database: ${t.error?.message}`))})}async function U(e,n){if(!e.trim())throw new Error("Mnemonic cannot be empty");if(!n.trim())throw new Error("Password cannot be empty");const t=crypto.getRandomValues(new Uint8Array(16)),o=crypto.getRandomValues(new Uint8Array(12)),r=await P(n,t,["encrypt"]),s=new TextEncoder().encode(e),i=await crypto.subtle.encrypt({name:"AES-GCM",iv:o},r,s),m={salt:f(t),iv:f(o),cipher:f(i)},u=await v();return new Promise((w,y)=>{const l=u.transaction(c.store_name,"readwrite").objectStore(c.store_name).put(m,c.vault_key);l.onsuccess=()=>w(),l.onerror=()=>y(new Error(`Failed to save vault: ${l.error?.message}`))})}async function D(e){if(!e.trim())throw new Error("Password cannot be empty");const n=await v(),t=await new Promise((u,w)=>{const p=n.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);p.onsuccess=()=>{const l=p.result;l?u(l):w(new Error("No vault found"))},p.onerror=()=>w(new Error(`Failed to load vault: ${p.error?.message}`))}),o=h(t.salt),r=h(t.iv),s=h(t.cipher),i=await P(e,o,["decrypt"]),m=await crypto.subtle.decrypt({name:"AES-GCM",iv:r},i,s).catch(u=>{throw u instanceof Error?new Error("Invalid password or corrupted vault"):new Error("invalid unkwown error")});return new TextDecoder().decode(m)}async function F(){const e=await v();return new Promise(n=>{const r=e.transaction(c.store_name,"readonly").objectStore(c.store_name).get(c.vault_key);r.onsuccess=()=>n(!!r.result),r.onerror=()=>n(!1)})}function K({authentication:e}){const[n,t]=d(""),[o,r]=d("test123"),s=e.state.value;return a("div",{children:[a("span",{children:["the current state is ",s]}),a("div",{style:{margin:"20px 0",border:"1px solid #ccc",padding:"10px"},children:[a("h3",{children:"Vault Test"}),a("input",{type:"password",value:o,onInput:u=>r(u.target.value),placeholder:"Password"}),a("br",{}),a("button",{type:"button",onClick:async()=>{await U("hello world",o)},children:'Store "hello world"'}),a("button",{type:"button",onClick:async()=>{const u=await D(o);t(u)},children:"Retrieve"}),n&&a("p",{children:n})]}),a("button",{type:"button",onClick:()=>{e.send({type:"LOCK"})},children:"lock"})]})}function L({authentication:e}){const[n,t]=d(""),[o,r]=d("smile price bomb movie minimum treat hurdle adult wing come space cross");return a("main",{children:[a("input",{placeholder:"Mnemonics",value:o,onInput:s=>{const i=s.currentTarget.value;r(i)}}),a("input",{placeholder:"Password",value:n,onInput:s=>{const i=s.currentTarget.value;t(i)}}),a("button",{type:"button",onClick:()=>{console.log("clicking"),e.send({type:"MNEMONICS_SUCCESS",password:n,mnemonics:o})},children:"unlock"})]})}function k(e,n){const t=x(e,n),[o,r]=d(()=>t.getSnapshot());return A(()=>{const s=t.subscribe(r);return t.start(),()=>{s.unsubscribe(),t.stop()}},[t]),[o,t.send,t]}const R=C({actions:{set_view:I({current:({event:e})=>e.view})}}),q=R.createMachine({id:"view",context:{current:"mnemonics"},on:{SET_VIEW:{actions:"set_view"}}});function V(){const[e,n,t]=k(q);return{state:e,send:n,actor:t}}const B=C({actors:{vault_verifier:N(async()=>({vault_exists:await F()}))},actions:{go_to_wallet:({context:e})=>{e.view.send({type:"SET_VIEW",view:"wallet"})}}}),G=B.createMachine({id:"authentication",initial:"locked",context:({input:e})=>({view:e.view}),states:{locked:{initial:"checking",states:{checking:{invoke:{src:"vault_verifier",onDone:[{target:"password",guard:({event:e})=>e.output.vault_exists},{target:"mnemonics"}]}},mnemonics:{on:{MNEMONICS_SUCCESS:{guard:({event:e})=>{console.log("event.mnemonics",e.mnemonics);const n=b(_(S(),g(1)),e.mnemonics).success;console.log("event.password",e.password);const t=b(_(S(),g(1)),e.password).success;return n&&t},target:"password"}}},password:{on:{PASSWORD_SUCCESS:{target:"#authentication.unlocked"}}}}},unlocked:{entry:"go_to_wallet",on:{LOCK:"locked"}}}});function j({view:e}){const[n,t,o]=k(G,{input:{view:e}});return{state:n,send:t,actor:o}}function W(){const e=V(),n=j({view:e.actor}),t=e.state.context.current;switch(t){case"mnemonics":return a(L,{authentication:n});case"password":return a(T,{authentication:n});case"wallet":return a(K,{authentication:n});default:return a("div",{children:["Unknown state: ",t]})}}O(a(W,{}),document.querySelector("#app"));
